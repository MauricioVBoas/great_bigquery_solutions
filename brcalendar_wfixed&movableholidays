CREATE OR REPLACE PROCEDURE seu_projeto.sua_dataset.d_brcalendar (ANOINI INT64, ANOFIM INT64)
BEGIN

--* PARAMETRIZA VARIAVEIS *
DECLARE ANO,MES,DIA,C,N,K,I1,I2,I3,J1,J2,L, CANO INT64;
DECLARE DSTART,DFINAL,DPAS,DCAR,DSEX,DCCH DATE;

--* INICIA O LOOPING DE ACORDO COM OS ANOS INFORMADOS *
REPEAT
SET ANO = ANOINI;

--* VALIDA SE O ANO JÁ EXISTE NA TABELA ANTES DE RE-INSERIR *
SET CANO = (SELECT EXTRACT(YEAR FROM DATE_KEY) FROM seu_projeto.sua_dataset.d_brcalendar WHERE EXTRACT(YEAR FROM DATE_KEY) = ANOINI GROUP BY 1);
IF CANO = ANO THEN
  DELETE FROM seu_projeto.sua_dataset.d_brcalendar WHERE EXTRACT(YEAR FROM DATE_KEY) = ANO;
END IF;

--* DEFINE PRIMEIRO E ULTIMO DIA DO ANO *
SET DSTART = DATE(PARSE_DATE('%Y%m%d',CAST(ANO * 10000 + 01 * 100 + 01 AS STRING)));
SET DFINAL = DATE(PARSE_DATE('%Y%m%d',CAST(ANO * 10000 + 12 * 100 + 31 AS STRING)));

--* INICIA O CALCULO PARA ENCONTRAR O DOMINGO DE PASCOA *
SET C   = CAST(ANO/100 AS INT64);
SET N   = ANO-19*CAST(FLOOR(ANO/19) AS INT64);
SET K   = CAST((N-17)/25 AS INT64);
SET I1  = (C-CAST(C/4 AS INT64))-CAST(FLOOR((C-K)/3) AS INT64)+19*N+15;
SET I2  = I1-30*CAST(FLOOR(I1/30) AS INT64);
SET I3  = I2-CAST(I2/28 AS INT64)*(1-CAST(I2/28 AS INT64))*CAST(29/(I2+1) AS INT64) *CAST((21-N)/11 AS INT64);
SET J1  = ANO+CAST(FLOOR(ANO/4) AS INT64)+I3+2-C+CAST(C/4 AS INT64);
SET J2  = J1-7 * CAST(FLOOR(J1/7) AS INT64);
SET L   = I3-J2;
SET MES = 3+CAST(FLOOR((L+40)/44) AS INT64);
SET DIA = L+28-31*CAST(FLOOR(MES/4) AS INT64);

--* DEFINE DEMAIS FERIADOS MOVEIS A PARTIR DA DATA DA PASCOA *
SET DPAS = DATE(PARSE_DATE('%Y%m%d',CAST(ANO * 10000 + MES * 100 + DIA AS STRING))); --PASCOA
SET DCAR = DATE_SUB(DATE(PARSE_DATE('%Y%m%d', CAST(ANO * 10000 + MES * 100 + DIA AS STRING))), INTERVAL  47 DAY); --CARNAVAL
SET DSEX = DATE_SUB(DATE(PARSE_DATE('%Y%m%d', CAST(ANO * 10000 + MES * 100 + DIA AS STRING))), INTERVAL   2 DAY); --sexta-feira santa 
SET DCCH = DATE_SUB(DATE(PARSE_DATE('%Y%m%d', CAST(ANO * 10000 + MES * 100 + DIA AS STRING))), INTERVAL -60 DAY); --corpus christi

--* INSERE OS DADOS NA TABELA *
INSERT INTO seu_projeto.sua_dataset.d_brcalendar

WITH
--* GERA DATAS USANDO ARRAY UNNEST *
GERADATAS AS (
SELECT
  DATE,
FROM UNNEST(GENERATE_DATE_ARRAY(DATE(PARSE_DATE('%Y%m%d',CAST(ANO*10000+01*100+01 AS STRING))),DATE(PARSE_DATE('%Y%m%d',CAST(ANO*10000+12*100+31 AS STRING))), INTERVAL 1 DAY)) AS DATE
),

--* DEFENE OS FERIADOS FIXOS E MOVEIS *
FERIADOS AS (
  SELECT
    DATE,
    CASE
      --feriados fixos
      WHEN EXTRACT(MONTH FROM DATE) = 1  AND EXTRACT(DAY FROM DATE) = 1  THEN "Ano Novo"
      WHEN EXTRACT(MONTH FROM DATE) = 4  AND EXTRACT(DAY FROM DATE) = 21 THEN "Tiradentes"
      WHEN EXTRACT(MONTH FROM DATE) = 5  AND EXTRACT(DAY FROM DATE) = 1  THEN "Dia do Trabalho"
      WHEN EXTRACT(MONTH FROM DATE) = 9  AND EXTRACT(DAY FROM DATE) = 7  THEN "Dia da Independêcia"
      WHEN EXTRACT(MONTH FROM DATE) = 10 AND EXTRACT(DAY FROM DATE) = 12 THEN "Dia de Nossa Senhora Aparecida"
      WHEN EXTRACT(MONTH FROM DATE) = 11 AND EXTRACT(DAY FROM DATE) = 2  THEN "Finados"
      WHEN EXTRACT(MONTH FROM DATE) = 11 AND EXTRACT(DAY FROM DATE) = 15 THEN "Proclamação da Republica"
      WHEN EXTRACT(MONTH FROM DATE) = 11 AND EXTRACT(DAY FROM DATE) = 20 THEN "Consciência Negra"
      WHEN EXTRACT(MONTH FROM DATE) = 12 AND EXTRACT(DAY FROM DATE) = 25 THEN "Natal"                           
      --feriados moveis
      WHEN EXTRACT(YEAR  FROM DATE) = EXTRACT(YEAR  FROM DPAS) AND 
           EXTRACT(MONTH FROM DATE) = EXTRACT(MONTH FROM DPAS) AND 
           EXTRACT(DAY   FROM DATE) = EXTRACT(DAY   FROM DPAS) THEN  "Domingo de Pascoa"
      WHEN EXTRACT(YEAR  FROM DATE) = EXTRACT(YEAR  FROM DCAR) AND 
           EXTRACT(MONTH FROM DATE) = EXTRACT(MONTH FROM DCAR) AND 
           EXTRACT(DAY   FROM DATE) = EXTRACT(DAY   FROM DCAR) THEN  "Carnaval"
      WHEN EXTRACT(YEAR  FROM DATE) = EXTRACT(YEAR  FROM DSEX) AND 
           EXTRACT(MONTH FROM DATE) = EXTRACT(MONTH FROM DSEX) AND 
           EXTRACT(DAY   FROM DATE) = EXTRACT(DAY   FROM DSEX) THEN  "Sexta-feira Santa"
      WHEN EXTRACT(YEAR  FROM DATE) = EXTRACT(YEAR  FROM DCCH) AND 
           EXTRACT(MONTH FROM DATE) = EXTRACT(MONTH FROM DCCH) AND 
           EXTRACT(DAY   FROM DATE) = EXTRACT(DAY   FROM DCCH) THEN  "Corpus Christi"                       END AS FERIADO,
  FROM GERADATAS )

--* SAIDA *
--* ALTERE AS ESTRUTURA DO CONTEUDO DA TABELA A PARTIR DESTE PONTO, CASO NECESSÁRIO *
SELECT
  DATE_DIFF(DATE, "1997-10-07", DAY) AS DATE_ID,
  DATE AS DATE_KEY,
  CASE
    WHEN EXTRACT(DAYOFWEEK FROM DATE) = 1 THEN "Domingo"
    WHEN EXTRACT(DAYOFWEEK FROM DATE) = 2 THEN "Segunda-feira"
    WHEN EXTRACT(DAYOFWEEK FROM DATE) = 3 THEN "Terça-feira"
    WHEN EXTRACT(DAYOFWEEK FROM DATE) = 4 THEN "Quarta-feira"
    WHEN EXTRACT(DAYOFWEEK FROM DATE) = 5 THEN "Quinta-feira"
    WHEN EXTRACT(DAYOFWEEK FROM DATE) = 6 THEN "Sexta-feira"
    WHEN EXTRACT(DAYOFWEEK FROM DATE) = 7 THEN "Sábado"         END AS WEEK_DAY,
  CASE
    WHEN FERIADO IS NOT NULL THEN FERIADO
    WHEN EXTRACT(DAYOFWEEK FROM DATE) BETWEEN 2 AND 6 THEN "Dia Útil" ELSE  "Fim de Semana" END AS DATE_DESC,
  DATE_SUB(DATE, INTERVAL   1 YEAR) AS DATE_LY,
  DATE_SUB(DATE, INTERVAL 364 DAY ) AS DATE_COMP_LY,
  DATE_SUB(DATE, INTERVAL  28 DAY ) AS DATE_COMP_LM,
  CURRENT_DATETIME('America/Sao_Paulo') AS TIME_STAMP,
FROM FERIADOS;

--* VALIDAÇÃO DO LOOP *
SET ANOINI = ANOINI + 1;
UNTIL ANO >= (ANOFIM)
END REPEAT;

--* it has made by Mauricio Villas Boas on nov/30th/2023 *
--* in case any question or doubts just text me for help *
--* FIM DA PROCEDURE *
END;
